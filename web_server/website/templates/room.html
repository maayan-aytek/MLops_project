<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Rooms - CustomTales</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="{{ url_for('views.home_view') }}">Home</a></li>
            <li><a href="{{ url_for('views.about_us') }}">About Us</a></li>
            <li><a href="{{ url_for('auth.sign_up') }}">Sign Up</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('views.choose_action') }}">Choose Activity</a></li>
                <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('auth.login') }}">Login</a></li>
            {% endif %}
        </ul>
    </nav>

    <div class="game-container">
      <div class="question-box">
          <h2>Current Question</h2>
          <div id="current-question" class="question"></div>
      </div>

      <div class="book-container">
          <!-- <img src="{{ url_for('static', filename='book_image.png') }}" alt="Magical Book" class="book-image"> -->
      </div>

      <!-- Define 5 participant positions -->
      <div class="participant top-participant">
          <h3 id="participant-top"></h3>
          <div id="qa-top"></div>
      </div>
      <div class="participant left-participant">
          <h3 id="participant-left"></h3>
          <div id="qa-left"></div>
      </div>
      <div class="participant right-participant">
          <h3 id="participant-right"></h3>
          <div id="qa-right"></div>
      </div>
      <div class="participant bottom-left-participant">
          <h3 id="participant-bottom-left"></h3>
          <div id="qa-bottom-left"></div>
      </div>
      <div class="participant bottom-right-participant">
          <h3 id="participant-bottom-right"></h3>
          <div id="qa-bottom-right"></div>
      </div>
    </div>

    <div class="participant-box">
        <h3>It's <span id="current-participant"></span>'s turn to answer.</h3>
    </div>

    <!-- Answer box for the current participant -->
    <div class="answer-box">
        <textarea id="answer" rows="4" placeholder="Type your answer here..." disabled></textarea>
        <button id="submit-btn" onClick="sendAnswer()" disabled>Submit Answer</button>
    </div>

    <!-- Message and story generation -->
    <div id="message-box" style="color: red;"></div>
    <div id="generating-story-message" style="display: none;">
        <h2>Generating the story...</h2>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous">
</script>
<script type="text/javascript">
  const roomCode = "{{ room_code }}"; // Ensure room_code is passed to the template
  var socketio = io();

  const currentQuestion = document.getElementById("current-question");
  const currentParticipant = document.getElementById("current-participant");
  const answerInput = document.getElementById("answer");
  const submitButton = document.getElementById("submit-btn");
  const messageBox = document.getElementById("message-box");
  const participantsContainer = document.getElementById("participants-container");
  const generatingStoryMessage = document.getElementById("generating-story-message");

  socketio.on("question", (data) => {
    currentQuestion.innerText = data.question;
    currentParticipant.innerText = data.is_participant_turn ? "your" : data.current_participant_name;

    if (data.is_participant_turn) {
      answerInput.disabled = false;
      submitButton.disabled = false;
    } else {
      answerInput.disabled = true;
      submitButton.disabled = true;
    }
  });

  socketio.on("finish_turn", (data) => {
    if (data.is_last_turn) {
        // Show "Generating the story..." message
        generatingStoryMessage.style.display = 'block';

        // Emit event to generate the story
        socketio.emit("generate_story", { room_code: `${data.room_code}` });

        // Hide all other elements
        document.querySelector('.participant-sections').style.display = 'none';
        document.querySelector('.question-box').style.display = 'none';
        document.querySelector('.participant-box').style.display = 'none';
        document.querySelector('.answer-box').style.display = 'none';
    } else {
        // Proceed to the next turn
        socketio.emit("next_turn", { room_code: `${data.room_code}` });
    }
  });

  socketio.on("unauthorized", (data) => {
    messageBox.innerText = data.message;
  });

  socketio.on("update_participant_data", (data) => {
    // Define all possible positions
    const positions = ["top", "left", "right", "bottom-left", "bottom-right"];

    // Hide all participant sections initially
    // positions.forEach(position => {
    //     const participantNameElem = document.getElementById(`participant-${position}`);
    //     const qaContainer = document.getElementById(`qa-${position}`);
    //     participantNameElem.innerText = '';
    //     qaContainer.innerHTML = '';
    //     // participantNameElem.parentElement.style.display = 'none';
    // });

      
      const participantData = data.participants[data.current_participant_name];
      const position = participantData.position; // Ensure this matches the backend

      // Show and set participant's name in the correct position
      const participantNameElem = document.getElementById(`participant-${position}`);
      participantNameElem.innerText = participantData.name;
      participantNameElem.parentElement.style.display = 'block';

      // Get the question and answer container for this participant
      const qaContainer = document.getElementById(`qa-${position}`);
      qaContainer.innerHTML = '';
      
      // Populate questions and answers
      participantData.questions.forEach((question, index) => {
          // Create a div to hold the question-answer pair
          const qaPairDiv = document.createElement('div');

          // Create and set question element
          const questionElem = document.createElement('p');
          questionElem.innerText = `Q${index + 1}: "${question}"`;
          qaPairDiv.appendChild(questionElem);

          // Create and set answer element
          const answerElem = document.createElement('p');
          answerElem.innerText = `A${index + 1}: "${participantData.answers[index]}"`;
          qaPairDiv.appendChild(answerElem);

          // Append the question-answer pair to the container
          qaContainer.appendChild(qaPairDiv);
      });
});

  const sendAnswer = () => {
    const answer = answerInput.value;
    const question = currentQuestion.innerText;
    if (answer === "" || question === "") return;
    socketio.emit("answer", { room_code: roomCode, question: question, answer: answer });
    answerInput.value = "";
  };
  
socketio.on("story", (data) => {
            generatingStoryMessage.style.display = 'none';
            const storyElement = document.createElement('div');
            storyElement.className = 'story-box';
            storyElement.innerHTML = `<h2>${data.title}</h2><p>${data.story}</p>`;
            document.querySelector('.participant-sections').parentNode.appendChild(storyElement);
        });

// Emit join event to receive the current question and participant

socketio.emit("join", { room_code: roomCode });
</script>
</body>
</html>