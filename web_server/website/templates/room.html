<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Rooms - CustomTales</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="{{ url_for('views.home_view') }}">Home</a></li>
            <li><a href="{{ url_for('views.about_us') }}">About Us</a></li>
            <li><a href="{{ url_for('auth.sign_up') }}">Sign Up</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('views.choose_action') }}">Choose Activity</a></li>
                <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('auth.login') }}">Login</a></li>
            {% endif %}
        </ul>
    </nav>

<div class="participant-sections">
  <!-- Container for dynamically generated participant sections -->
  <div id="participants-container"></div>
</div>

<div class="question-box">
  <h2>Current Question</h2>
  <div id="current-question" class="question"></div>
</div>

<div class="participant-box">
  <h3>It's <span id="current-participant"></span>'s turn to answer.</h3>
</div>

<div class="answer-box">
  <textarea id="answer" rows="4" placeholder="Type your answer here..." disabled></textarea>
  <button id="submit-btn" onClick="sendAnswer()" disabled>Submit Answer</button>
</div>

<div id="message-box" style="color: red;"></div>

<div id="generating-story-message" style="display: none;">
  <h2>Generating the story...</h2>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous">
</script>
<script type="text/javascript">
  const roomCode = "{{ room_code }}"; // Ensure room_code is passed to the template
  var socketio = io();

  const currentQuestion = document.getElementById("current-question");
  const currentParticipant = document.getElementById("current-participant");
  const answerInput = document.getElementById("answer");
  const submitButton = document.getElementById("submit-btn");
  const messageBox = document.getElementById("message-box");
  const participantsContainer = document.getElementById("participants-container");
  const generatingStoryMessage = document.getElementById("generating-story-message");

  socketio.on("question", (data) => {
    currentQuestion.innerText = data.question;
    currentParticipant.innerText = data.is_participant_turn ? "your" : data.current_participant_name;

    if (data.is_participant_turn) {
      answerInput.disabled = false;
      submitButton.disabled = false;
    } else {
      answerInput.disabled = true;
      submitButton.disabled = true;
    }
  });

  socketio.on("finish_turn", (data) => {
    if (data.is_last_turn) {
        // Show "Generating the story..." message
        generatingStoryMessage.style.display = 'block';

        // Emit event to generate the story
        socketio.emit("generate_story", { room_code: `${data.room_code}` });

        // Hide all other elements
        document.querySelector('.participant-sections').style.display = 'none';
        document.querySelector('.question-box').style.display = 'none';
        document.querySelector('.participant-box').style.display = 'none';
        document.querySelector('.answer-box').style.display = 'none';
    } else {
        // Proceed to the next turn
        socketio.emit("next_turn", { room_code: `${data.room_code}` });
    }
  });

  socketio.on("unauthorized", (data) => {
    messageBox.innerText = data.message;
  });

  socketio.on("update_participant_data", (data) => {
    // Clear previous data
    participantsContainer.innerHTML = '';

    // Add participant sections dynamically
    Object.keys(data.participants).forEach(participantId => {
        const participantData = data.participants[participantId];
        
        // Create a new participant section
        const section = document.createElement('div');
        section.className = 'participant-box';
        section.id = `participant-${participantId}`;

        // Add participant name
        const nameElem = document.createElement('h3');
        nameElem.innerText = participantData.name || `Participant ${participantId}`; // Use participant's name or fallback
        section.appendChild(nameElem);

        // Add questions and answers
        const qaDiv = document.createElement('div');
        qaDiv.className = 'qa';
        section.appendChild(qaDiv);

        // Populate questions and answers
        participantData.questions.forEach((question, index) => {
            const questionElem = document.createElement('div');
            questionElem.innerText = `q${index + 1}: "${question}"`;
            qaDiv.appendChild(questionElem);

            const answerElem = document.createElement('div');
            answerElem.innerText = `a${index + 1}: "${participantData.answers[index]}"`;
            qaDiv.appendChild(answerElem);
        });

        participantsContainer.appendChild(section);
    });
});

  const sendAnswer = () => {
    const answer = answerInput.value;
    const question = currentQuestion.innerText;
    if (answer === "" || question === "") return;
    socketio.emit("answer", { room_code: roomCode, question: question, answer: answer });
    answerInput.value = "";
  };
  
  socketio.on("story", (data) => {
    // Hide all elements
    generatingStoryMessage.style.display = 'none';
    document.querySelector('.participant-sections').style.display = 'none';
    document.querySelector('.question-box').style.display = 'none';
    document.querySelector('.participant-box').style.display = 'none';
    document.querySelector('.answer-box').style.display = 'none';
    messageBox.style.display = 'none'; // Hide the message box as well

    // Create a new element to display the story
    const storyElement = document.createElement('div');
    storyElement.className = 'story-box';
    storyElement.innerHTML = `<h2>${data.title}</h2><p>${data.story}</p>`;
    
    // Append the story element to the main content area
    document.querySelector('.participant-sections').parentNode.appendChild(storyElement);
});

  // Emit join event to receive the current question and participant
  socketio.emit("join", { room_code: roomCode });
</script>
</body>
</html>